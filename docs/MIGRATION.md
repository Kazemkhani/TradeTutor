# Migration Guide: Stateless Multi-Tenant MVP

This document describes breaking changes from the original Lead-based schema to the new stateless MVP schema.

## Overview

The original schema was designed for a persistent lead management system. The new schema is designed for a **stateless multi-tenant MVP** where:

- No accounts, no saved businesses, no dashboards
- Any visitor can submit a form and trigger an outbound call immediately
- All data is ephemeral (max 10 minute TTL)
- No database required

---

## Removed Models

| Old Model | Replacement | Notes |
|-----------|-------------|-------|
| `Lead` | Form fields in `CallRequest` | Lead data now comes directly from form submission |
| `AgentSpec` | Form fields + generated `agent_instructions` | Agent config is now derived from style/goal/target |
| `QualificationStatus` | `CallStatus` | Simplified to call lifecycle only |

---

## New Models

### `CallRequest` (Form Submission)

Replaces direct Lead creation. All fields come from the web form.

```python
class CallRequest(BaseModel):
    # Required
    phone: str              # E.164 format
    product: str            # What are you selling?
    offer_pricing: str      # Price/offer details
    target: TargetAudience  # consumer/sme/enterprise/other
    goal: CallGoal          # qualify_interest/book_meeting/collect_info/confirm_order
    style: AgentStyle       # professional/friendly/assertive/luxury/concise

    # Optional
    name: str | None
    booking_link: str | None    # For goal=book_meeting
    constraints: str | None     # Restrictions/notes
    turnstile_token: str | None # Cloudflare Turnstile
    consent: bool = False       # Must be True to proceed
```

### `ContextInstance` (Built by DSPy)

New structure with form fields + generated content.

```python
class ContextInstance(BaseModel):
    id: UUID
    created_at: datetime

    # From form (copied from CallRequest)
    phone: str
    name: str | None
    product: str
    offer_pricing: str
    target: TargetAudience
    goal: CallGoal
    style: AgentStyle
    booking_link: str | None
    constraints: str | None

    # Generated by DSPy
    agent_instructions: str       # Full system prompt
    opening_line: str             # What agent says first
    qualification_questions: list[str]
    objection_handlers: dict[str, str]
    closing_script: str

    # SMS config
    should_send_sms: bool
    sms_message: str | None
```

### `CallJob` (Ephemeral)

Now includes TTL enforcement.

```python
class CallJob(BaseModel):
    id: UUID
    created_at: datetime
    context_id: UUID        # Reference, not embedded
    phone: str
    status: CallStatus
    started_at: datetime | None
    ended_at: datetime | None
    sms_sent: bool = False
    error: str | None

    # TTL (computed)
    expires_at: datetime    # created_at + 600 seconds

    # Methods
    def is_expired(self) -> bool
    def seconds_until_expiry(self) -> float
```

---

## Field Mapping

### Lead → CallRequest

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `phone` | `phone` | Same |
| `name` | `name` | Same (optional) |
| `company` | - | Removed (not needed for MVP) |
| `email` | - | Removed (not needed for MVP) |
| `source` | - | Removed (not needed for MVP) |
| `qualification_status` | - | Removed (use CallJob.status) |
| `notes` | `constraints` | Repurposed |

### AgentSpec → Form Fields

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `name` | - | Removed |
| `instructions` | `agent_instructions` | Now generated by DSPy |
| `style` | `style` | Now an enum (AgentStyle) |
| `objective` | `goal` | Now an enum (CallGoal) |
| `tools` | - | Removed |
| `voice_id` | - | Moved to env config |
| `llm_model` | - | Moved to env config |
| `stt_model` | - | Moved to env config |
| `tts_model` | - | Moved to env config |

### Old ContextInstance → New ContextInstance

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `lead` | Form fields directly | Flattened |
| `agent_spec` | Form fields + generated | Flattened |
| `business_context` | `product` + `offer_pricing` | Split |
| `qualification_questions` | `qualification_questions` | Same, now generated |
| `objection_handlers` | `objection_handlers` | Same, now generated |
| `call_objective` | `goal` + `agent_instructions` | Derived |

### Old CallJob → New CallJob

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `lead_id` | - | Removed (no leads) |
| `context_instance_id` | `context_id` | Renamed |
| `context_instance_path` | - | Removed (inline) |
| `status` | `status` | Same |
| `scheduled_at` | - | Removed (immediate) |
| `started_at` | `started_at` | Same |
| `ended_at` | `ended_at` | Same |
| `recording_url` | - | Removed (not MVP) |
| `transcript` | - | Removed (not MVP) |
| `outcome` | - | Removed (use status) |
| - | `phone` | Added |
| - | `sms_sent` | Added |
| - | `error` | Added |
| - | `expires_at` | Added (computed) |

---

## New Enums

### `TargetAudience`
```python
CONSUMER = "consumer"
SME = "sme"
ENTERPRISE = "enterprise"
OTHER = "other"
```

### `CallGoal`
```python
QUALIFY_INTEREST = "qualify_interest"
BOOK_MEETING = "book_meeting"
COLLECT_INFO = "collect_info"
CONFIRM_ORDER = "confirm_order"
```

### `AgentStyle`
```python
PROFESSIONAL = "professional"
FRIENDLY = "friendly"
ASSERTIVE = "assertive"
LUXURY = "luxury"
CONCISE = "concise"
```

### `CallStatus`
```python
PENDING = "pending"
IN_PROGRESS = "in_progress"
COMPLETED = "completed"
FAILED = "failed"
```

---

## TTL Enforcement

All `CallJob` records expire after **10 minutes** (600 seconds).

```python
from shared.schemas import CALL_JOB_TTL_SECONDS  # 600

job = CallJob(context_id=ctx.id, phone="+1...")

# Check if expired
if job.is_expired():
    # Safe to delete
    pass

# Get seconds remaining
remaining = job.seconds_until_expiry()  # Can be negative if expired

# Get exact expiry time
expiry = job.expires_at
```

---

## API Changes

### Old Endpoints (Removed)
- `POST /leads` - Create lead
- `GET /leads/{id}` - Get lead
- `GET /leads` - List leads
- `POST /calls/trigger` - Trigger call for lead

### New Endpoints
- `POST /calls` - Submit form & trigger call (accepts `CallRequest`)
- `GET /calls/{id}` - Get call status (returns `CallStatusResponse`)
- `GET /contexts/{id}` - Get context for debugging
- `GET /health` - Health check with active call count

---

## Validation Changes

1. **Consent required**: `CallRequest.consent` must be `True`
2. **IP rate limiting**: Max 5 requests per 60 seconds per IP
3. **Turnstile validation**: Optional Cloudflare captcha
4. **Enum validation**: target/goal/style must be valid enum values

---

## Import Changes

All imports should come from `shared.schemas`:

```python
# Old (don't do this)
from some_package import Lead, AgentSpec

# New (correct)
from shared.schemas import (
    CallRequest,
    ContextInstance,
    CallJob,
    TargetAudience,
    CallGoal,
    AgentStyle,
    CallStatus,
    CALL_JOB_TTL_SECONDS,
)
```
